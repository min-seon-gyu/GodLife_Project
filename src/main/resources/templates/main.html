<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <link
            th:href="@{/css/bootstrap.min.css}"
            href="../css/bootstrap.min.css"
            rel="stylesheet"
    />
    <style>
      .background {
        width: 100vw;

        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      .container {
        max-width: 1200px;
      }


    </style>
</head>
<body>

<div class="background">
    <div class="container">
        <div align="right" style="margin-top: 20px">
            <h5 style="display:inline; vertical-align: middle; font-weight : bold;" th:text="|ì•ˆë…•í•˜ì„¸ìš” ${name}ë‹˜!!|"></h5>
            <a href="/createUpdateMemberView" class="btn btn-secondary" role="button" >ë§ˆì´í˜ì´ì§€</a>
            <button type="button" class="btn btn-secondary" onclick=logout() >ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div>
            <a th:href="|/move/previous/${day}|" class="btn btn-secondary" role="button" style="display:inline;">ì´ì „</a>
            <input type="text" id="datePicker" class="form-control" th:value="${day}" style="width:270px; display:inline;">
            <a th:href="|/move/next/${day}|" class="btn btn-secondary" role="button" style="display:inline;">ë‹¤ìŒ</a>
        </div>

        <h2 style="margin-top: 30px; font-weight : bold;" th:text="|${day} ì¼ì • (ìµœëŒ€ 5ê°œ)|"></h2>
        <th:block th:each="schedule : ${schedules}">
            <div style="margin-top: 20px">
                <div style="display:inline;">
                    <h4 th:if="${schedule.status == true}" th:text="|ğŸ˜¸ ${schedule.content}|" style="display:inline; vertical-align: middle;" ></h4>
                    <h4 th:if="${schedule.status == false}" th:text="|ğŸ˜¹ ${schedule.content}|" style="display:inline; vertical-align: middle;" ></h4>
                </div>
                <div style="margin-top: 10px">
                    <button th:if="${past == 'false'}" class="change-btn" th:attr="id=${schedule.id}" style="border-radius: 15px; font-weight : bold; background-color: #f5ebe0">
                        <p th:if="${schedule.status == true}" style="display:inline;" >ë¯¸ì™„</p>
                        <p th:if="${schedule.status == false}" style="display:inline;">ì™„ë£Œ</p>
                    </button>
                    <button th:if="${past == 'false'}" class="update-btn" th:attr="id=${schedule.id}, content=${schedule.content}" style="border-radius: 15px; font-weight : bold; background-color: #f5ebe0">ìˆ˜ì •</button>
                    <button th:if="${past == 'false'}" class="delete-btn" th:attr="id=${schedule.id}" style="border-radius: 15px; font-weight : bold; background-color: #f5ebe0">ì‚­ì œ</button>
                </div>
            </div>
        </th:block>
        <button th:if="${past == 'false'}" id="openAddModal" style="font-weight : bold; background: #e3d5ca; border-radius: 15px; margin-top: 30px" >ì¶”ê°€í•˜ê¸°</button>

        <br>

        <div style="margin-top: 20px">
            <label>ê²€ìƒ‰í•  ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 2ì, ìµœëŒ€ 30ì ì…ë‹ˆë‹¤.)</label><br>
            <input type="search" id="findContent" maxlength="30" minlength="2" style="vertical-align: middle;">
            <button type="button" id="openFindModal" class="btn btn-secondary" style="vertical-align: middle;">ê²€ìƒ‰</button>
        </div>

        <!--Modal-->

        <div id="addModal" class="modal">
            <div class="modal-content">
                <label>ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 2ì, ìµœëŒ€ 30ì ì…ë‹ˆë‹¤.)</label>
                <input type="text" id="addContent" style="margin-top: 10px" class="form-control" maxlength="30"
                       minlength="2">
                <div align="right" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick=add()>ì¶”ê°€</button>
                    <button type="button" class="btn btn-secondary" id="close-add-btn">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

        <div id="updateModal" class="modal">
            <div class="modal-content">
                <label>ì¼ì •ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 2ì, ìµœëŒ€ 30ì ì…ë‹ˆë‹¤.)</label>
                <input type="text" id="updateContent" style="margin-top: 10px" class="form-control" maxlength="30"
                       minlength="2">
                <div align="right" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick=update()>ìˆ˜ì •</button>
                    <button type="button" class="btn btn-secondary" id="close-update-btn">ë‹«ê¸°</button>
                </div>
            </div>
        </div>



        <div id="findModal" class="modal">
            <div class="modal-content">
                <h3 id="subtitle"></h3>
                <div style="overflow:auto; height: 300px;" id="modalData"></div>
                <button style="display: none" type="button" class="btn btn-secondary" id="more-find-btn" onclick="more()">ë”ë³´ê¸°</button>
                <div align="right" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" id="close-find-btn">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    $('#datePicker')
        .datepicker({
            changeYear: true,
            changeMonth: true,
            showOtherMonths: true,
            showButtonPanel: true,
            dateFormat: 'yy-mm-dd',
            minDate: '2000-01-01',
            maxDate: '2099-12-31',
            yearRange: '2000:2099',
            closeText: 'ë‹«ê¸°',
            currentText: 'ì˜¤ëŠ˜',
            prevText: 'ì´ì „ ë‹¬',
            nextText: 'ë‹¤ìŒ ë‹¬',
            monthNames: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
            monthNamesShort: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'],
            dayNames: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
            dayNamesShort: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
            dayNamesMin: ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '],
            showMonthAfterYear: true,
            yearSuffix: 'ë…„',
            onSelect: function(dateText, inst) {
                var day = $(this).val();
                var year = day.substr(0, 4);
                var month = day.substr(5, 2);
                var date = day.substr(8, 2);
                location.replace(`/schedule/${year}/${month}/${date}`)
            }
        });

    function logout() {
        fetch("/logout", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
        })
        .then(res => {
            if(res.status === 200){
               window.location.href=window.location.href
            }else{
               alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        });
   }

   <!--ì¼ì •ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜-->
   function add() {
       <!--ì¼ì •ì„ ì¶”ê°€í•  ë•Œ í•„ìš”í•œ ë‚ ì§œì™€ ë‚´ìš©ì„ ê°€ì ¸ì˜¨ë‹¤.-->
       var date = document.getElementById("datePicker").value;
       var content = document.getElementById("addContent").value;
       <!--POST ìš”ì²­ìœ¼ë¡œ ì „ì†¡-->
       fetch("/schedule", {
           method: "POST",
           headers: {
               "Content-Type": "application/json"
           },
           body: JSON.stringify({
                date: date,
                content: content
            })
       })
       .then(res => {
           if(res.status === 400){
           console.log(res);
               alert("ì…ë ¥í•˜ì‹  ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
           }else if(res.status === 500){
               alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
           }else if(res.status === 200){
               <!--ì¼ì • ì¶”ê°€ ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨-->
               window.location.href=window.location.href
           }
       });
   }

   <!--ì¼ì •ì„ ìˆ˜ì •í•˜ëŠ” í•¨ìˆ˜-->
   function update() {
       <!--ì¼ì •ì„ ìˆ˜ì •í•  ë•Œ í•„ìš”í•œ ì•„ì´ë””ì™€ ë‚´ìš©ì„ ê°€ì ¸ì˜¨ë‹¤.-->
       var id = document.getElementById("updateContent").getAttribute("content_id");
       var content = document.getElementById("updateContent").value;
       <!--FETCH ìš”ì²­ìœ¼ë¡œ ì „ì†¡-->
       fetch("/schedule", {
           method: "PATCH",
           headers: {
               "Content-Type": "application/json"
           },
           body: JSON.stringify({
                id: id,
                content: content
            })
       })
       .then(res => {
           if(res.status === 400){
               alert("ì…ë ¥í•˜ì‹  ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
           }else if(res.status === 500){
               alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
           }else if(res.status === 200){
               <!--ì¼ì • ìˆ˜ì • ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨-->
               window.location.href=window.location.href
           }
       });
   }

   <!--ì¼ì •ì„ ì¶”ê°€ ê²€ìƒ‰í•˜ëŠ” í•¨ìˆ˜-->
   function more() {
       <!--ì¼ì •ì„ ì¶”ê°€ ê²€ìƒ‰í•  ë•Œ í•„ìš”í•œ ë‚´ìš©ê³¼ ë²„íŠ¼, ì¸ë±ìŠ¤ë¥¼ ê°€ì ¸ì˜¨ë‹¤.-->
       var content = document.getElementById("findContent").value;
       var btn = document.getElementById("more-find-btn");
       <!--GET ìš”ì²­ìœ¼ë¡œ ì „ì†¡-->
       fetch(`/search_schedule/${content}/${btn.getAttribute("index")}`, {
           method: "GET"
       })
       .then(res => {
           if(res.status === 400){
               alert("ì…ë ¥í•˜ì‹  ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
           }else if(res.status === 500){
               alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
           }else if(res.status === 200){
               <!--Promise ë°˜í™˜-->
               return res.json();
           }
       })
       .then(data => {
           <!--ê¸°ì¡´ í…Œì´ë¸” ê°€ì ¸ì˜¤ê¸°-->
           const table = document.getElementById('modalData').querySelector('table');
           <!--í…Œì´ë¸”ì— í–‰ ì¶”ê°€í•˜ê¸°-->
           data.lst.forEach(item => {
               const row = table.insertRow();
               Object.values(item).forEach(value => {
                   const cell = row.insertCell();
                   cell.textContent = value;
                   cell.style.width = '33.33%'
               });
           });

           <!--ë‹¤ìŒ ë°ì´í„°ê°€ ì¡´ì¬í•˜ë©´ 'ë”ë³´ê¸°' ë²„íŠ¼ ë³´ì´ê²Œ ì„¤ì •í•˜ê³  ë‹¤ìŒ ì¸ë±ìŠ¤ë„ ì„¤ì •-->
           if(data.hasNext){
               btn.style.display = "block";
               btn.setAttribute("index", data.nextIndex);
           }
           <!--ë‹¤ìŒ ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 'ë”ë³´ê¸°' ë²„íŠ¼ ì•ˆë³´ì´ê²Œ ì„¤ì •-->
           else{
               btn.style.display = "none";
           }
       });
   }

document.addEventListener("DOMContentLoaded", function() {

  var changeButtons = document.querySelectorAll(".change-btn");

  changeButtons.forEach(function(button) {
    button.addEventListener("click", function() {
      var id = button.getAttribute("id");
      fetch("/schedule/changeStatus", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: id
        })
      })
      .then(res => {
        if(res.status === 200){
          window.location.href=window.location.href
        }else{
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      });
    });
  });

  var deleteButtons = document.querySelectorAll(".delete-btn");

  deleteButtons.forEach(function(button) {
    button.addEventListener("click", function() {
      var id = button.getAttribute("id");
      var date = document.getElementById("datePicker").value;
      fetch("/schedule", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: id,
          date: date
        })
      })
      .then(res => {
        if(res.status === 200){
          window.location.href=window.location.href
        }else{
          alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      });
    });
  });

  var updateButtons = document.querySelectorAll(".update-btn");

  updateButtons.forEach(function(button) {
    button.addEventListener("click", function() {
      var content = button.getAttribute("content");
      var id = button.getAttribute("id");
      var updateContent = document.getElementById("updateContent");
      updateModal.style.display = "block";
      updateContent.value = content;
      updateContent.setAttribute("content_id", id);
    });
  });
});

    // ì¼ì • ì¶”ê°€ Modal
    var openAddModalBtn = document.getElementById("openAddModal");
    var closeAddModalBtn = document.getElementById("close-add-btn");
    var addModal = document.getElementById("addModal");
    var addContent = document.getElementById("addContent");

    if(openAddModalBtn !== null){
        openAddModalBtn.onclick = function() {
            addModal.style.display = "block";
        }
    }

    closeAddModalBtn.onclick = function() {
        addModal.style.display = "none";
        addContent.value = "";
    }

    // ì¼ì • ìˆ˜ì • Modal
    var closeUpdateModalBtn = document.getElementById("close-update-btn");
    var updateModal = document.getElementById("updateModal");

    closeUpdateModalBtn.onclick = function() {
        updateModal.style.display = "none";
    }

    // ì¼ì • ê²€ìƒ‰ Modal
    var openFindModalBtn = document.getElementById("openFindModal");
    var closeFindModalBtn = document.getElementById("close-find-btn");
    var findModal = document.getElementById("findModal");

    openFindModalBtn.onclick = function() {
       var content = document.getElementById("findContent").value;
       fetch(`/search_schedule/${content}/0`, {
           method: "GET"
       })
       .then(res => {
           if(res.status === 400){
               alert("ì…ë ¥í•˜ì‹  ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
           }else if(res.status === 500){
               alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
           }else if(res.status === 200){
               return res.json();
           }
       })
       .then(data => {
           document.getElementById("subtitle").textContent = `'${content}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.`;
           var btn = document.getElementById("more-find-btn");

           const table = document.createElement('table');
           table.style.width = '100%';
           const headerRow = table.insertRow();
           const headers = ['ì¼ì •', 'ë‚´ìš©', 'ì™„ë£Œ']; // ì„ì˜ì˜ í—¤ë” ì¶”ê°€
           headers.forEach(headerText => {
               const th = document.createElement('th');
               th.textContent = headerText;
               th.style.width = '33.33%'
               headerRow.appendChild(th);
           });

           data.lst.forEach(item => {
               const row = table.insertRow();
               Object.values(item).forEach(value => {
                   const cell = row.insertCell();
                   cell.textContent = value;
                   cell.style.width = '33.33%'
               });
           });

           if(data.hasNext){
               btn.style.display = "block";
               btn.setAttribute("index", data.nextIndex);
           }
           else{
                btn.style.display = "none";
           }

           const modalDataContainer = document.getElementById('modalData');
           modalDataContainer.innerHTML = ''; // ëª¨ë‹¬ ë‚´ìš© ì´ˆê¸°í™”
           modalDataContainer.appendChild(table);
           findModal.style.display = "block";
       });
    }

    closeFindModalBtn.onclick = function() {
        findModal.style.display = "none";
    }

    // ê³µí†µ
    window.onclick = function(event) {
        if (event.target == addModal) {
            addModal.style.display = "none";
            addContent.value = "";
        }
        if (event.target == updateModal) {
            updateModal.style.display = "none";
        }
        if (event.target == findModal) {
            findModal.style.display = "none";
        }
    }
</script>
</body>
</html>